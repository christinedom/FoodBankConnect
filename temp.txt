# ------------------------------
# DB apply: run your loader directly (no Docker-in-Docker, no ECR/Batch)
# ------------------------------
apply_db:
  stage: backend_release
  image: python:3.12-slim
  variables:
    LOG_LEVEL: "INFO"
    TRUNCATE: "1"
    DRY_RUN: "0"
    SCRAPERS_DIR: "$CI_PROJECT_DIR/fbc-load-db/scrapers"
    DB_HOST: "fbc-psql-db.chyoag62glut.us-east-2.rds.amazonaws.com"
    DB_PORT: "5432"
    DB_NAME: "postgres"
    DB_USER: "postgres"
    DB_PASSWORD: "HardcoreHenry1!"
    DB_SCHEMA: "app"
    PYTHONUNBUFFERED: "1"
    PYTHONIOENCODING: "utf-8"
    PYTHONPATH: "$CI_PROJECT_DIR:$CI_PROJECT_DIR/fbc-load-db"
  before_script:
    - python -V
    - python -m pip install --upgrade pip
    - |
      if [ -f fbc-load-db/requirements.txt ]; then
        pip install --no-input -r fbc-load-db/requirements.txt
      elif [ -f requirements.txt ]; then
        pip install --no-input -r requirements.txt
      else
        pip install --no-input "sqlalchemy>=2" "psycopg2-binary>=2.9"
      fi
  script:
    - |
      set -euo pipefail

      # Check that files exist
      test -f "fbc-load-db/main.py" || { echo "ERROR: fbc-load-db/main.py not found."; exit 1; }
      test -f "fbc-load-db/scraper.py" || { echo "ERROR: fbc-load-db/scraper.py not found."; exit 1; }
      test -f "$SCRAPERS_DIR/scrapers.txt" || { echo "ERROR: scrapers.txt not found in $SCRAPERS_DIR"; exit 1; }

      # Check individual DB vars instead of DATABASE_URL
      for var in DB_HOST DB_PORT DB_NAME DB_USER DB_PASSWORD DB_SCHEMA; do
        if [ -z "${!var:-}" ]; then
          echo "ERROR: $var is not set in CI/CD variables."
          exit 2
        fi
      done

      echo "Running database apply using fbc-load-db/main.py..."
      python fbc-load-db/main.py
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: on_success
    - when: manual
      allow_failure: false
