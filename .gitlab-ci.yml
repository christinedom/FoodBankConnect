stages:
  - deploy

deploy_website:
  stage: deploy
  image: amazon/aws-cli:2.15.5
  script:
    # Export GitLab CI/CD variables so AWS CLI can use them
    - export AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID
    - export AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY
    - export AWS_DEFAULT_REGION=$AWS_DEFAULT_REGION

    # Debug step: make sure credentials work
    - echo "Testing AWS CLI access..."
    - aws s3 ls

    # Sync local folder to S3 bucket
    - echo "Syncing public/ to S3 bucket..."
    - aws s3 sync public/ s3://$AWS_BUCKET_NAME --delete

    # Invalidate CloudFront cache
    - echo "Creating CloudFront invalidation..."
    - aws cloudfront create-invalidation --distribution-id $CLOUDFRONT_DIST_ID --paths "/*"

  only:
    - main
