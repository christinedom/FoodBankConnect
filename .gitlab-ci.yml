stages:
  - build
  - deploy         
  - backend_release 
  - backend_test    
  - selenium_tests

# ------------------------------------------------
# GLOBAL ENVIRONMENT VARIABLES
# ------------------------------------------------
variables:
  REQUIREMENTS_FILE_UNIT: "fbc-load-db/requirements.txt"
  REQUIREMENTS_FILE_API:  "fbc-rest-api/requirements.txt"

  PYTEST_WORKDIR: "fbc-load-db"
  PYTEST_TESTPATH: "fbc-load-db/tests"
  PYTEST_IGNORE: "frontend/src/selenium_tests"

  REPORT_DIR: "reports"
  PYTEST_JUNIT_XML: "$REPORT_DIR/pytest-report.xml"
  PYTEST_COVERAGE_XML: "$REPORT_DIR/coverage.xml"

  POSTMAN_COLLECTION: "tests/postman/collection.json"
  NEWMAN_JUNIT_XML: "$REPORT_DIR/newman-results.xml"

  API_APP_ENTRY: "fbc-rest-api/main.py"
  API_HEALTH_URL: "http://localhost:8080/health"

# ------------------------------------------------
# Frontend build and deploy remain the same
# ------------------------------------------------
build_react:
  stage: build
  image: node:20-bullseye
  script:
    - cd frontend
    - npm ci
    - CI=false npm run build
  artifacts:
    paths:
      - frontend/build
  rules:
    # Allow override via variable in the UI or API
    - if: '$FORCE_FRONTEND == "1"'
      when: on_success

    # Build only if relevant files changed
    - changes:
        - frontend/**/*  
        - frontend/.env*      
        - package.json         
        - package-lock.json
        - frontend/package.json  
        - frontend/package-lock.json
      when: on_success

    # Default: skip
    - when: never


deploy_website:
  stage: deploy
  image:
    name: amazon/aws-cli
    entrypoint: [""]
  dependencies:
    - build_react
  script:
    - aws s3 sync frontend/build/ s3://$S3_BUCKET --delete
    - aws cloudfront create-invalidation --distribution-id $CLOUDFRONT_DIST_ID --paths "/*"
  rules:
    # Allow manual forcing
    - if: '$FORCE_FRONTEND == "1" && $CI_COMMIT_BRANCH == "main"'
      when: on_success

    # Deploy only on main when frontend changed (i.e., build ran)
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - frontend/**/*
        - frontend/.env*
        - package.json
        - package-lock.json
        - frontend/package.json
        - frontend/package-lock.json
      when: on_success

    # Default: skip
    - when: never


# ------------------------------------------------
# Backend: Unit tests with pytest
# ------------------------------------------------
backend_unit_tests:
  stage: backend_test
  image: python:3.12-bullseye
  before_script:
    - python -V
    - pip install -r "$REQUIREMENTS_FILE_UNIT"
    - pip install pytest pytest-cov
    - mkdir -p "$CI_PROJECT_DIR/$REPORT_DIR"
  script:
    - |
      if [ -n "$PYTEST_WORKDIR" ]; then cd "$PYTEST_WORKDIR"; fi
      pytest -q --maxfail=1 --disable-warnings \
        --cov=. \
        --ignore="$CI_PROJECT_DIR/$PYTEST_IGNORE" \
        "$CI_PROJECT_DIR/$PYTEST_TESTPATH" \
        --cov-report=xml:"$CI_PROJECT_DIR/$PYTEST_COVERAGE_XML" \
        --junitxml "$CI_PROJECT_DIR/$PYTEST_JUNIT_XML"
  artifacts:
    when: always
    reports:
      junit: $PYTEST_JUNIT_XML
      coverage_report:
        coverage_format: cobertura
        path: $PYTEST_COVERAGE_XML
    paths:
      - $PYTEST_JUNIT_XML
      - $PYTEST_COVERAGE_XML
  rules:
    - changes:
        - fbc-load-db/**/*
      when: on_success
    - when: never


# ------------------------------------------------
# Backend: API tests with Newman/Postman
# ------------------------------------------------
backend_api_tests:
  stage: backend_test
  image: node:20-bullseye
  before_script:
    - apt-get update && apt-get install -y python3 python3-pip curl
    - pip install -r "$REQUIREMENTS_FILE_API"
    - npm install -g newman
    - mkdir -p "$CI_PROJECT_DIR/$REPORT_DIR"
  script:
    # Start your API app if it exists
    - |
      if [ -f "$API_APP_ENTRY" ]; then
        python3 "$API_APP_ENTRY" & echo $! > flask.pid
        for i in {1..60}; do curl -sf "$API_HEALTH_URL" && break; sleep 1; done || true
      fi

    # Run collection and always write the JUnit file where artifacts expect it
    - newman run "$POSTMAN_COLLECTION" \
        --reporters cli,junit \
        --reporter-junit-export "$CI_PROJECT_DIR/$NEWMAN_JUNIT_XML" || NEWMAN_RC=$?

    # Cleanup and ensure artifact exists
    - if [ -f flask.pid ]; then kill "$(cat flask.pid)" || true; fi
    - if [ ! -s "$CI_PROJECT_DIR/$NEWMAN_JUNIT_XML" ]; then echo "<testsuite></testsuite>" > "$CI_PROJECT_DIR/$NEWMAN_JUNIT_XML"; fi
    - exit ${NEWMAN_RC:-0}
  artifacts:
    when: always
    reports:
      junit: $NEWMAN_JUNIT_XML
    paths:
      - $NEWMAN_JUNIT_XML
  rules:
    - changes:
        - fbc-rest-api/**/*
        - tests/postman/**/*
      when: on_success
    - when: never



# ------------------------------------------------
# Frontend tests: Tests with selenium
# ------------------------------------------------
selenium_tests:
  stage: selenium_tests
  image: python:3.12-bullseye
  before_script:
    - apt-get update && apt-get install -y wget unzip xvfb libxi6 libgconf-2-4 gnupg
    # Install Google Chrome
    - wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | apt-key add -
    - echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" > /etc/apt/sources.list.d/google-chrome.list
    - apt-get update && apt-get install -y google-chrome-stable
    # Match ChromeDriver to Chrome major version
    - CHROME_VERSION=$(google-chrome --version | grep -oP '\d+\.\d+\.\d+')
    - wget -q "https://chromedriver.storage.googleapis.com/$CHROME_VERSION/chromedriver_linux64.zip"
    - unzip chromedriver_linux64.zip
    - mv chromedriver /usr/local/bin/
    - chmod +x /usr/local/bin/chromedriver
    # Python deps for Selenium tests
    - pip install -r "frontend/tests/requirements.txt"
    - pip install pytest
  script:
    - cd frontend/src/selenium_tests
    - python -m pytest -q --maxfail=1 --disable-warnings \
        --junitxml "$CI_PROJECT_DIR/reports/selenium-junit.xml"
  artifacts:
    when: always
    reports:
      junit: reports/selenium-junit.xml
    paths:
      - reports/selenium-junit.xml
  rules:
    - changes:
        - frontend/src/selenium_tests/**/*
        - frontend/tests/requirements.txt
      when: on_success
    - when: never
